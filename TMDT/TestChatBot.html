<!-- TEST CHATBOT NHANH -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test ChatBot API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            border: 2px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #ffba00;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #ff9800;
        }
        .result {
            background: #f5f5f5;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        input {
            padding: 8px;
            width: 300px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üß™ Test ChatBot API</h1>
    <p>C√¥ng c·ª• n√†y gi√∫p ki·ªÉm tra c√°c API endpoint c·ªßa ChatBot</p>

    <!-- Test 1: Check Login -->
    <div class="test-section">
        <h3>1Ô∏è‚É£ Ki·ªÉm tra ƒêƒÉng nh·∫≠p</h3>
        <button onclick="testLogin()">Test Login Status</button>
        <div id="loginResult" class="result"></div>
    </div>

    <!-- Test 2: Send Message -->
    <div class="test-section">
        <h3>2Ô∏è‚É£ G·ª≠i tin nh·∫Øn ƒë·∫øn Admin</h3>
        <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." value="Test message from user">
        <button onclick="testSendMessage()">G·ª≠i tin nh·∫Øn</button>
        <div id="sendResult" class="result"></div>
    </div>

    <!-- Test 3: Get Messages -->
    <div class="test-section">
        <h3>3Ô∏è‚É£ L·∫•y danh s√°ch tin nh·∫Øn</h3>
        <button onclick="testGetMessages()">L·∫•y tin nh·∫Øn</button>
        <div id="getResult" class="result"></div>
    </div>

    <!-- Test 4: Get Unread Count -->
    <div class="test-section">
        <h3>4Ô∏è‚É£ ƒê·∫øm tin nh·∫Øn ch∆∞a ƒë·ªçc</h3>
        <button onclick="testUnreadCount()">ƒê·∫øm tin nh·∫Øn</button>
        <div id="countResult" class="result"></div>
    </div>

    <!-- Test 5: Check Table -->
    <div class="test-section">
        <h3>5Ô∏è‚É£ Ki·ªÉm tra Database Table</h3>
        <p>Ch·∫°y SQL query sau trong SQL Server Management Studio:</p>
        <div class="result">
SELECT COUNT(*) as TotalMessages,
       SUM(CASE WHEN isFromAdmin = 0 THEN 1 ELSE 0 END) as UserMessages,
       SUM(CASE WHEN isFromAdmin = 1 THEN 1 ELSE 0 END) as AdminMessages,
       SUM(CASE WHEN isRead = 0 THEN 1 ELSE 0 END) as UnreadMessages
FROM ChatBotMessages;
        </div>
    </div>

    <script>
        function showResult(elementId, message, isSuccess) {
            const el = document.getElementById(elementId);
            el.innerHTML = message;
            el.style.color = isSuccess ? 'green' : 'red';
        }

        // Test 1: Check Login
        function testLogin() {
            showResult('loginResult', '‚è≥ ƒêang ki·ªÉm tra...', false);
            
            fetch('/Chat/GetMyChatBotMessages')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        showResult('loginResult', 
                            '‚úÖ ƒê√É ƒêƒÇNG NH·∫¨P\n' +
                            'B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng chat v·ªõi admin!', 
                            true);
                    } else {
                        showResult('loginResult', 
                            '‚ùå CH∆ØA ƒêƒÇNG NH·∫¨P\n' +
                            'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi s·ª≠ d·ª•ng chat v·ªõi admin.\n' +
                            'Nh·∫•n "ƒêƒÉng nh·∫≠p" ·ªü g√≥c tr√™n c√πng trang web.', 
                            false);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showResult('loginResult', 
                        '‚ùå L·ªñI AJAX\n' +
                        'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server.\n' +
                        'Error: ' + error.message, 
                        false);
                });
        }

        // Test 2: Send Message
        function testSendMessage() {
            const message = document.getElementById('messageInput').value;
            if (!message) {
                showResult('sendResult', '‚ùå Vui l√≤ng nh·∫≠p tin nh·∫Øn', false);
                return;
            }

            showResult('sendResult', '‚è≥ ƒêang g·ª≠i tin nh·∫Øn...', false);

            fetch('/Chat/SendUserChatBotMessage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'message=' + encodeURIComponent(message)
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    showResult('sendResult', 
                        '‚úÖ G·ª¨I TIN NH·∫ÆN TH√ÄNH C√îNG!\n' +
                        'Tin nh·∫Øn: "' + message + '"\n' +
                        'ƒê√£ l∆∞u v√†o database.\n' +
                        'Admin s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o.', 
                        true);
                } else {
                    showResult('sendResult', 
                        '‚ùå G·ª¨I TIN NH·∫ÆN TH·∫§T B·∫†I\n' +
                        'L·ªói: ' + data.message + '\n' +
                        'Vui l√≤ng ki·ªÉm tra ƒëƒÉng nh·∫≠p.', 
                        false);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showResult('sendResult', 
                    '‚ùå L·ªñI AJAX\n' +
                    'Error: ' + error.message, 
                    false);
            });
        }

        // Test 3: Get Messages
        function testGetMessages() {
            showResult('getResult', '‚è≥ ƒêang t·∫£i tin nh·∫Øn...', false);

            fetch('/Chat/GetMyChatBotMessages')
                .then(response => response.json())
                .then(data => {
                    console.log('Messages:', data);
                    if (data.success) {
                        if (data.messages.length === 0) {
                            showResult('getResult', 
                                '‚úÖ KH√îNG C√ì TIN NH·∫ÆN\n' +
                                'B·∫°n ch∆∞a c√≥ tin nh·∫Øn chatbot n√†o.', 
                                true);
                        } else {
                            let messagesText = '‚úÖ C√ì ' + data.messages.length + ' TIN NH·∫ÆN:\n\n';
                            data.messages.forEach((msg, index) => {
                                messagesText += (index + 1) + '. ';
                                messagesText += msg.isFromAdmin ? '[ADMIN] ' : '[USER] ';
                                messagesText += msg.content;
                                messagesText += ' (' + msg.dateSent + ')';
                                messagesText += msg.isRead ? ' [ƒê√£ ƒë·ªçc]' : ' [Ch∆∞a ƒë·ªçc]';
                                messagesText += '\n';
                            });
                            showResult('getResult', messagesText, true);
                        }
                    } else {
                        showResult('getResult', 
                            '‚ùå KH√îNG TH·ªÇ T·∫¢I TIN NH·∫ÆN\n' +
                            'L·ªói: Ch∆∞a ƒëƒÉng nh·∫≠p', 
                            false);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showResult('getResult', 
                        '‚ùå L·ªñI AJAX\n' +
                        'Error: ' + error.message, 
                        false);
                });
        }

        // Test 4: Unread Count
        function testUnreadCount() {
            showResult('countResult', '‚è≥ ƒêang ƒë·∫øm...', false);

            fetch('/Chat/GetChatBotUnreadCount')
                .then(response => response.json())
                .then(data => {
                    console.log('Unread count:', data);
                    if (data.count !== undefined) {
                        showResult('countResult', 
                            '‚úÖ S·ªê TIN NH·∫ÆN CH∆ØA ƒê·ªåC: ' + data.count + '\n' +
                            (data.count > 0 ? 'B·∫°n c√≥ tin nh·∫Øn m·ªõi t·ª´ Admin!' : 'Kh√¥ng c√≥ tin nh·∫Øn m·ªõi.'), 
                            true);
                    } else {
                        showResult('countResult', 
                            '‚ùå KH√îNG TH·ªÇ ƒê·∫æM\n' +
                            'L·ªói: Ch∆∞a ƒëƒÉng nh·∫≠p', 
                            false);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showResult('countResult', 
                        '‚ùå L·ªñI AJAX\n' +
                        'Error: ' + error.message, 
                        false);
                });
        }

        // Auto test on load
        window.onload = function() {
            console.log('üß™ ChatBot API Test Page loaded');
            console.log('Trang n√†y gi√∫p test c√°c API endpoint c·ªßa ChatBot');
            
            // Auto check login status
            setTimeout(() => {
                testLogin();
            }, 500);
        };
    </script>
</body>
</html>
